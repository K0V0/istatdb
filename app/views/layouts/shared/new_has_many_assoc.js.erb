
// search-select section (widget)
var mainElem = $(document).find("#<%= params[:window_id] %>");
// table body
var tBody = mainElem.find("div.tablewrap").children("table").children("tbody");
// table rows
var rows = tBody.children("tr");
// for later use remember ids (vals) of buttons to avoid duplicates on refresh
var checked_btns_vals = []
// button that allows saving content of searchfields as new records
var alower = mainElem.find(".<%= params[:model] %>_allow_add_new");

// let checked values be there
rows.each(function() {
	var checkbox = $(this).children("td").children("input[type=checkbox]");

	if (checkbox.is(":checked")) {
		checked_btns_vals.push(checkbox.val());
	} else {
		$(this).remove();
	}
});

<% allow_new = @result.size > 0 ? "0" : "1" %>

//if (alower.data('user-choosed') == NULL) { 
	if ("<%= allow_new %>" == "1") {
		alower.prop('checked', true);
	} else {
		alower.prop('checked', false);
	}
//}

<% 
	template = []
	@result.each do |r|
		template << render('layouts/elements/table_list_checkboxes/row',
			obj_name: params[:source_controller],
			coll_name: "#{params[:model]}_ids",
			val_method: :id,
			label_method: get_fields_from_ransack_params,
			obj: r,
			opts: { is_highlighted: true }
		)
	end
%>

var results = jQuery.parseHTML("<%=j template.join('').html_safe %>");

// remove duplicates from results set, only append not duplicated
$(results).each(function() {
	var checkbox = $(this).children("td").children("input[type=checkbox]");

	if (checked_btns_vals.indexOf(checkbox.val()) == -1) {
		tBody.append($(this));
	} 
});
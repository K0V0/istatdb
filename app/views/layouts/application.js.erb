var an = "<%= an = action_name %>";

JS.H.run('on_change');
console.log("on_change");

<% #if performed? %>
	
	//JS.H.run('after_redirect');
	//console.log("after_redirect");

<% #end %>

<% if an != 'new_select_search' && an != 'new_select_load_items' && an != 'check_existence' && an != 'add_to_calculator_mem' && an != 'clear_calculator_mem' && an != 'remove_from_calculator_mem' && an != 'edit_rec_in_calculator_mem' && !params.has_key?(:norender_default_jserb) %>

	var AN = an.indexOf('_calculator_') > -1 ? 'show' : an;
	var CTRL = "<%= ctrl = controller_name %>";
	var TRID = "<%= @MEM.settings.gui_enable_3d == '1' ? 'tride' : '' %>"
	var body = $(document).find('body');

	var searchform_actions;
	var searchform_add_button;
	var searchform_edit_button;
	var searchform_delete_button;
	var searchform_administrative_button;
	var searchform_sortlink_remember_helper;
	var searchform_last_visits;
	var searchform_submit_button;

	body.data('controller_name', CTRL);
	body.data('action_name', AN);
	body.children('main').children('article').attr('class', AN+' <%= @items_table_class %> '+CTRL);
	body.attr('class',  AN+' '+CTRL+' '+TRID);

	$(document).find('nav.pagination').remove();

	JS.H.run('once');

	<% if !flash.empty? && user_signed_in? %>
		$('body > div.flash_messages')
			.empty()
			.append('<%=j render "layouts/base/flash_messages" %>')
			.addClass('visible');
	<% end %>

	<% if an=='index'||an=='show'||an=='search'||an=='administrative'||an=='end_administrative'||an=='delete'||an=='change_status'||an=='export' %>

		if (an != 'delete') {
			window.history.pushState("", "", "<%= url_for(action: action_name)%>");
		} else {
			window.history.pushState("", "", "<%= url_for(action: :index)%>");
		}

		searchform_actions = body.find('section.search_bar > form > div > div.searchform_actions');

		searchform_add_button = searchform_actions.children('a.add_item_from_search');

		searchform_edit_button = searchform_actions.children('a.edit_item_from_search');

		searchform_delete_button = searchform_actions.children('a.delete_item_from_search');

		searchform_submit_button = searchform_actions.children('#back_or_search');

		searchform_administrative_button = searchform_actions.children('a.administration_from_search');

		searchform_sortlink_remember_helper = body.find('section.search_bar > form > input#q_s');

		searchform_last_visits = body.find('select#last_visits');

		$('main > article').empty();

		var tiriri = (AN == "index")||(AN == "search");
		$('#back_or_search').val(
			tiriri ? t('search.submit') : t('actions.back')
		);

		<% if params.deep_has_key? :q, :s %>
			searchform_sortlink_remember_helper.val('<%= params[:q][:s] %>');
		<% end %>

	<% end %>

	<% if an=='index'||an=='search'||an=='administrative'||an=='end_administrative'||an=='delete'||an=='change_status' %>

		body.addClass('noscroll');
		searchform_edit_button.addClass('hidden');
		searchform_delete_button.addClass('hidden');
		searchform_administrative_button.removeClass('hidden');

	<% elsif an == 'show' %>

		var btn = $('<%=j render("layouts/shared/actions/search_or_back_button") %>');
		searchform_submit_button.remove();
		searchform_actions.append(btn);

		searchform_edit_button
			.removeClass('hidden')
			.attr('href', '<%= url_for(action: :edit) %>');

		searchform_delete_button
			.removeClass('hidden')
			.attr('href', '<%= url_for(action: :delete) %>');

		searchform_administrative_button.addClass('hidden');

		searchform_last_visits.children('option').each(function() {
			if ($(this).val() != "") { $(this).remove(); }
		});

		searchform_last_visits.append("<%=j options_for_select(@last_visits.map { |obj| [obj[:title], obj[:id]] }) %>");

	<% end %>

	<% if !@MEM.send("is_in_administrative_#{controller_name.singularize.underscore}").blank? %>

		searchform_administrative_button
			.addClass('selected')
			.attr('href', '<%= url_for(action: :end_administrative) %>')
			.text(t('actions.end_administrative'));

	<% else %>

		searchform_administrative_button
			.removeClass('selected')
			.attr('href', '<%= url_for(action: :administrative) %>')
			.text(t('actions.administrative'));

	<% end %>

	<% if content_for? :items_table %>

		$('<%=j yield(:items_table) %>').appendTo('main > article');

		$('<%=j paginate(@result, remote: true) if !@result.nil? %>').insertAfter('main');

		$('input[name=page]').remove();

	<% end %>

	<% if content_for? :show_content %>

		$('<%=j yield(:show_content) %>').appendTo('main > article');

		$('<input type="hidden" name="page" value="<%= params[:page] %>">').appendTo('body');

	<% end %>

<% end %>

<%= yield %>


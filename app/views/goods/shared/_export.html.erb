<%
    item_state = nil
    case is_param?(:uncomplete_filter)
        when "0"
            item_state = "len došetrené"
        when "1"
            item_state = "len nedošetrené"
        else
            item_state = "- bez obmedzenia -"
    end

    item_time_filter = "- bez obmedzenia -"
    if is_param?(:search_datetime)
        p = params[:q]
        timestring = "#[p['created_at_gteq(1i)']}"
        time = DateTime.parse("#{datetime_param(1)}-#{datetime_param(2)}-#{datetime_param(3)}-#{datetime_param(4)}:#{datetime_param(5)}")
        item_time_start = time.strftime("%d %B %Y, %H:%M")
        item_time_end = DateTime.current.strftime("%d %B %Y, %H:%M")
        item_time_filter = "#{item_time_start} - #{item_time_end}"
    end

    if is_param?(:search_datetime)
        time_filter_mode = "pridania alebo poslednej úpravy"
        if params.has_key? :timesort_method
            case params[:timesort_method].to_s
                when "created_at_or_updated_at_gteq"
                    # nic
                when "created_at_gteq"
                    time_filter_mode = "pridania"
                when "updated_at_gteq"
                    time_filter_mode = "poslednej úpravy"
            end
        end
    else
        time_filter_mode = "---"
    end
%>


<%
fields_to_export = {
    ident: [],
    description: [],
    note: [],
    uncomplete_reason: [],
    uncomplete: [],
    user_added: [],
    user_modded: [],
    issues: [
        :name_field
    ],
    local_taric: [
        :kncode,
        :description
    ],
    manufacturers: [
        :name
    ],
    impexpcompanies: [
        :company_name
    ],
    uoms: [
        :uom,
        :uom_multiplier,
        :type
    ]
}

head = [
    ["Referencia alebo popis tovaru obsahuje: ", is_param?(:ident_or_description_cont)||is_param?(:ident_cont)],
    ["Popis tovaru obsahuje: ", is_param?(:description_cont)],
    ["Spravodajská jednotka: ", Impexpcompany.where(id: is_param?(:impexpcompany_filter)).pluck(:company_name)],
    ["Výrobcovia/Odberatelia: ", Manufacturer.where(id: is_param?(:manufacturer_filter)).pluck(:name)],
    ["Stav položky: ", item_state],
    ["Časové obdobie: ", item_time_filter],
    ["Filtrované podľa času: ", time_filter_mode],
    ["Prípad(y): ",
        Issue.where(id: is_param?(:issue_filter))
            .select(:name, :season).all
            .map{ |f| "#{f.name} #{f.season.strftime('%m/%Y')}" }
    ]
]
%>

<%= render(
    'layouts/shared/export',
    fields_to_select: fields_to_export,
    head: head
) %>